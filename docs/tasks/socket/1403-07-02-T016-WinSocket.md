# T016 - Win Socket

## توضیحات تسک
پیاده‌سازی سوکت برای نمایش برنده‌های بازی بینگو (خطی و کلی).

## Socket Details
- **Namespace**: `/rooms`
- **Event ارسال**: `winRequest`
- **Event دریافت**: `win`

## ورودی
```json
{
  "activeRoomId": 1
}
```

## خروجی موفق
```json
{
  "namespace": "/rooms",
  "event": "win",
  "data": {
    "activeRoomId": 1,
    "lineWinners": [
      {
        "userId": 123,
        "cardId": 456,
        "amount": 50000
      }
    ],
    "fullWinners": [
      {
        "userId": 789,
        "cardId": 654,
        "amount": 150000
      }
    ],
    "gameFinished": true
  }
}
```

## منطق پیاده‌سازی

### تشخیص برنده خطی (Line Winner Detection)
1. بررسی وجود برنده خطی قبلی برای روم
2. دریافت تمام اعداد خوانده شده برای روم
3. بررسی تمام کارت‌های رزرو شده برای روم
4. برای هر کارت، بررسی هر خط (سطر) کارت
5. اگر تمام اعداد یک خط در اعداد خوانده شده وجود داشته باشند → برنده خطی
6. هر کاربر فقط یک بار می‌تواند برنده خطی شود
7. پس از یافتن حداقل یک برنده خطی، بررسی خطی متوقف می‌شود

### تشخیص برنده کلی (Full Winner Detection)
1. دریافت تمام اعداد خوانده شده برای روم
2. بررسی تمام کارت‌های رزرو شده برای روم
3. اگر تمام اعداد یک کارت در اعداد خوانده شده وجود داشته باشند → برنده کلی
4. هر کاربر فقط یک بار می‌تواند برنده کلی شود
5. پس از یافتن حداقل یک برنده کلی، بازی تمام می‌شود

## فایل‌های ایجاد/تغییر شده
- `src/entities/active-room-winners.entity.ts` - ایجاد entity جدید
- `src/entities/index.ts` - اضافه کردن export
- `src/modules/socket/rooms.service.ts` - اضافه کردن متدهای تشخیص برنده
- `src/modules/socket/rooms.gateway.ts` - اضافه کردن event handler
- `src/modules/socket/socket.module.ts` - اضافه کردن repository های جدید
- `src/modules/socket-mock/socket-mock.controller.ts` - اضافه کردن mock endpoint
- `src/modules/socket-mock/socket-mock.module.ts` - اضافه کردن repository های جدید

## تاریخ ایجاد
1403/07/02

## وضعیت
✅ تکمیل شده

## نحوه استفاده
```javascript
const socket = io('http://localhost:3006/rooms');

socket.emit('winRequest', { activeRoomId: 1 });

socket.on('win', (data) => {
  console.log('Line Winners:', data.data.lineWinners);
  console.log('Full Winners:', data.data.fullWinners);
  console.log('Game Finished:', data.data.gameFinished);
});
```

## قوانین مهم
- برنده خطی فقط یک بار برای هر روم تعیین می‌شود
- برنده کلی باعث پایان بازی در روم می‌شود
- اگر یک کاربر چند کارت همزمان برنده شود → فقط اولین کارت او ذخیره می‌شود
- مبلغ برنده خطی: 50,000 تومان
- مبلغ برنده کلی: 150,000 تومان

